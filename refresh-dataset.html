<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ƒêang l√†m m·ªõi d·ªØ li·ªáu Power BI dataset...</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding-top: 60px; }
    #status { font-size: 1.2em; margin-top: 20px; }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    #timer { margin-top: 10px; font-size: 0.9em; color: #555; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h2 id="title">üîÑ ƒêang l√†m m·ªõi d·ªØ li·ªáu Power BI...</h2>
  <div class="loader"></div>
  <div id="status">Vui l√≤ng ch·ªù trong gi√¢y l√°t...</div>
  <div id="timer"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const groupId = params.get("groupId");
    const dataflowId = params.get("dataflowId");
    const datasetId = params.get("datasetId");
    const requestId = params.get("requestId") || generateRequestId();
    
    // URL cho c√°c API m·ªõi
    const triggerUrl = `https://pbirefresh.azurewebsites.net/api/TriggerRefresh?groupId=${groupId}&dataflowId=${dataflowId}&datasetId=${datasetId}&requestId=${requestId}`;
    const statusUrl = `https://pbirefresh.azurewebsites.net/api/CheckRefreshStatus?groupId=${groupId}&dataflowId=${dataflowId}&datasetId=${datasetId}&requestId=${requestId}`;

    // Ki·ªÉm tra tham s·ªë b·∫Øt bu·ªôc
    if (!groupId || (!dataflowId && !datasetId)) {
      document.getElementById("status").textContent = "‚ùå Thi·∫øu tham s·ªë trong URL. C·∫ßn c√≥ groupId v√† √≠t nh·∫•t m·ªôt trong dataflowId ho·∫∑c datasetId.";
      document.querySelector(".loader").style.display = "none";
    } else {
      refreshPowerBI();
    }

    // T·∫°o requestId n·∫øu kh√¥ng ƒë∆∞·ª£c cung c·∫•p
    function generateRequestId() {
      return `req_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
    }

    // Hi·ªÉn th·ªã ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c / th·ªùi gian ch·ªù
    let seconds = 0;
    const timerEl = document.getElementById("timer");
    setInterval(() => {
      seconds++;
      timerEl.textContent = `‚è± ƒê√£ ch·ªù: ${Math.floor(seconds/60)} ph√∫t ${seconds%60} gi√¢y`;
    }, 1000);

    async function refreshPowerBI() {
      document.getElementById("status").textContent = "üöÄ G·ª≠i y√™u c·∫ßu l√†m m·ªõi Power BI...";
      try {
        const res = await fetchWithTimeout(triggerUrl, { method: "GET" }, 600000);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const result = await res.json();
        
        if (!result || result.error) {
          throw new Error(result.error || "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ server");
        }
        
        document.getElementById("status").textContent = "‚úÖ Y√™u c·∫ßu l√†m m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i. ƒêang theo d√µi...";
        pollStatus(requestId, statusUrl);
      } catch (err) {
        showError("g·ª≠i y√™u c·∫ßu l√†m m·ªõi", err);
      }
    }

    // H√†m chung ƒë·ªÉ poll tr·∫°ng th√°i v·ªõi retry logic
    function pollStatus(requestId, url) {
      let retries = 0, maxRetries = 3;
      const interval = setInterval(async () => {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          
          // Hi·ªÉn th·ªã tr·∫°ng th√°i
          let statusText = "‚è≥ ƒêang theo d√µi tr·∫°ng th√°i...";
          let isCompleted = false;
          let isFailed = false;
          
          if (data.dataflow) {
            statusText = `‚è≥ Dataflow: ${data.dataflow.status || "ƒêang ch·ªù"}`;
            if (data.dataflow.status === "DataflowCompleted") {
              statusText += " ‚úÖ";
            } else if (data.dataflow.status === "DataflowFailed") {
              statusText += " ‚ùå";
              isFailed = true;
            }
          }
          
          if (data.dataset) {
            statusText += `<br>‚è≥ Dataset: ${data.dataset.status || "ƒêang ch·ªù"}`;
            if (data.dataset.status === "DatasetCompleted") {
              statusText += " ‚úÖ";
            } else if (data.dataset.status === "DatasetFailed") {
              statusText += " ‚ùå";
              isFailed = true;
            }
          }
          
          document.getElementById("status").innerHTML = statusText;
          
          // Ki·ªÉm tra n·∫øu c·∫£ hai ƒë·ªÅu ho√†n th√†nh ho·∫∑c m·ªôt trong hai th·∫•t b·∫°i
          const dataflowCompleted = !data.dataflow || data.dataflow.status === "DataflowCompleted";
          const datasetCompleted = !data.dataset || data.dataset.status === "DatasetCompleted";
          
          if ((dataflowCompleted && datasetCompleted) || isFailed) {
            clearInterval(interval);
            
            if (isFailed) {
              document.getElementById("title").textContent = "‚ùå L√†m m·ªõi th·∫•t b·∫°i!";
              document.getElementById("status").textContent = "C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh l√†m m·ªõi.";
            } else {
              document.getElementById("title").textContent = "‚úÖ L√†m m·ªõi ho√†n t·∫•t!";
              document.getElementById("status").textContent = "To√†n b·ªô qu√° tr√¨nh l√†m m·ªõi ƒë√£ ho√†n t·∫•t th√†nh c√¥ng.";
            }
            
            document.querySelector(".loader").style.display = "none";
          }
        } catch (err) {
          if (retries < maxRetries) {
            retries++;
            console.warn(`Retry ${retries}/${maxRetries} do l·ªói:`, err);
          } else {
            clearInterval(interval);
            showError("ki·ªÉm tra tr·∫°ng th√°i", err);
          }
        }
      }, 30000); // Ki·ªÉm tra m·ªói 30 gi√¢y
    }

    // Fetch c√≥ timeout
    function fetchWithTimeout(resource, options = {}, timeout = 60000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(id));
    }

    function showError(context, err) {
      document.getElementById("title").textContent = "‚ùå C√≥ l·ªói x·∫£y ra";
      document.getElementById("status").textContent = `L·ªói khi ${context}: ${err.message}`;
      document.querySelector(".loader").style.display = "none";
    }
  </script>
</body>
</html>
