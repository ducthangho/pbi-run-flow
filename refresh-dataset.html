<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:,">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ƒêang l√†m m·ªõi d·ªØ li·ªáu Power BI dataset...</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding-top: 60px; max-width: 800px; margin: 0 auto; }
    #status { font-size: 1.2em; margin-top: 20px; }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    #timer { margin-top: 10px; font-size: 0.9em; color: #555; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .detail-box { 
      background-color: #f8f9fa; 
      border-radius: 8px; 
      padding: 15px; 
      margin-top: 20px;
      text-align: left;
      font-size: 0.9em;
      display: none;
    }
    .detail-row {
      display: flex;
      margin-bottom: 8px;
    }
    .detail-label {
      width: 120px;
      font-weight: bold;
    }
    .badge {
      display: inline-block;
      padding: 0.25em 0.6em;
      font-size: 0.75em;
      font-weight: 700;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 0.25rem;
      margin-left: 5px;
    }
    .badge-primary { background-color: #007bff; color: white; }
    .badge-success { background-color: #28a745; color: white; }
    .badge-danger { background-color: #dc3545; color: white; }
    .badge-warning { background-color: #ffc107; color: #212529; }
    .badge-secondary { background-color: #6c757d; color: white; }
    .btn {
      display: inline-block;
      font-weight: 400;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: 0.25rem;
      margin-top: 20px;
    }
    .btn-info { background-color: #17a2b8; color: white; border: none; }
    .btn-info:hover { background-color: #138496; }
    .hidden { display: none; }
    /* Form styles for POST method support */
    #paramForm {
      margin: 20px auto;
      max-width: 500px;
      text-align: left;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    .form-group .form-text {
      font-size: 0.8em;
      color: #6c757d;
      margin-top: 5px;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    .checkbox-group input {
      margin-right: 8px;
      width: auto;
    }
  </style>
</head>
<body>
  <h2 id="title">üîÑ ƒêang l√†m m·ªõi d·ªØ li·ªáu Power BI...</h2>
  
  <!-- Form for manual input (only shown when no query params are available) -->
  <div id="paramForm" class="hidden">
    <h3>Nh·∫≠p th√¥ng tin l√†m m·ªõi</h3>
    <form id="refreshForm" method="post">
      <div class="form-group">
        <label for="groupId">Workspace ID (b·∫Øt bu·ªôc)</label>
        <input type="text" id="groupId" name="groupId" required>
      </div>
      <div class="form-group">
        <label for="dataflowId">Dataflow ID</label>
        <input type="text" id="dataflowId" name="dataflowId">
        <div class="form-text">B·ªè tr·ªëng n·∫øu ch·ªâ l√†m m·ªõi dataset</div>
      </div>
      <div class="form-group">
        <label for="datasetId">Dataset ID</label>
        <input type="text" id="datasetId" name="datasetId">
        <div class="form-text">B·ªè tr·ªëng n·∫øu ch·ªâ l√†m m·ªõi dataflow</div>
      </div>
      <div class="form-group">
        <label for="requestId">Request ID (t√πy ch·ªçn)</label>
        <input type="text" id="requestId" name="requestId">
        <div class="form-text">N·∫øu b·ªè tr·ªëng, h·ªá th·ªëng s·∫Ω t·ª± t·∫°o</div>
      </div>
      <div class="form-group">
        <label for="apiBaseUrl">API Base URL (t√πy ch·ªçn)</label>
        <input type="text" id="apiBaseUrl" name="apiBaseUrl" placeholder="https://pbirefresh.azurewebsites.net/api">
      </div>
      <div class="form-group checkbox-group">
        <input type="checkbox" id="autoClose" name="autoClose" value="true">
        <label for="autoClose">T·ª± ƒë·ªông ƒë√≥ng c·ª≠a s·ªï sau khi ho√†n th√†nh</label>
      </div>
      <div class="form-group checkbox-group">
        <input type="checkbox" id="showDetails" name="showDetails" value="true">
        <label for="showDetails">Hi·ªÉn th·ªã chi ti·∫øt</label>
      </div>
      <button type="submit" class="btn btn-info">B·∫Øt ƒë·∫ßu l√†m m·ªõi</button>
    </form>
  </div>

  <div class="loader" id="loader"></div>
  <div id="status">Vui l√≤ng ch·ªù trong gi√¢y l√°t...</div>
  <div id="timer"></div>
  <button id="toggleDetails" class="btn btn-info hidden">Hi·ªÉn th·ªã chi ti·∫øt</button>
  
  <div id="details" class="detail-box">
    <div class="detail-row">
      <div class="detail-label">Request ID:</div>
      <div id="detail-requestId"></div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Group ID:</div>
      <div id="detail-groupId"></div>
    </div>
    <div class="detail-row" id="row-dataflowId">
      <div class="detail-label">Dataflow ID:</div>
      <div id="detail-dataflowId"></div>
    </div>
    <div class="detail-row" id="row-datasetId">
      <div class="detail-label">Dataset ID:</div>
      <div id="detail-datasetId"></div>
    </div>
    <div class="detail-row">
      <div class="detail-label">Tr·∫°ng th√°i:</div>
      <div id="detail-status"></div>
    </div>
    <div class="detail-row">
      <div class="detail-label">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</div>
      <div id="detail-lastUpdated"></div>
    </div>
  </div>

  <script>
    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ tham s·ªë
    let globalParams = {
      groupId: null,
      dataflowId: null,
      datasetId: null,
      requestId: null,
      autoClose: false,
      showDetails: false,
      apiBaseUrl: "https://pbirefresh.azurewebsites.net/api"
    };
    
    // Kh·ªüi t·∫°o bi·∫øn tr·∫°ng th√°i
    let hasDataflow = false;
    let hasDataset = false;
    let isRefreshCompleted = false;
    let refreshFailed = false;
    let pollTimeoutId = null;
    let triggerUrl = "";
    let statusUrl = "";

    // T·∫°o requestId n·∫øu kh√¥ng ƒë∆∞·ª£c cung c·∫•p
    function generateRequestId() {
      return `req_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
    }

    // Kh·ªüi t·∫°o v√† ki·ªÉm tra tham s·ªë
    async function init() {
      // Ki·ªÉm tra xem form ƒë√£ ƒë∆∞·ª£c submit b·∫±ng POST ch∆∞a
      const formData = await getFormDataFromPost();
      
      // L·∫•y tham s·ªë t·ª´ URL (GET method)
      const urlParams = new URLSearchParams(window.location.search);
      
      // ∆Øu ti√™n l·∫•y tham s·ªë t·ª´ POST tr∆∞·ªõc, sau ƒë√≥ l√† GET
      globalParams.groupId = formData.get("groupId") || urlParams.get("groupId") || null;
      globalParams.dataflowId = formData.get("dataflowId") || urlParams.get("dataflowId") || null;
      globalParams.datasetId = formData.get("datasetId") || urlParams.get("datasetId") || null;
      globalParams.requestId = formData.get("requestId") || urlParams.get("requestId") || generateRequestId();
      globalParams.autoClose = formData.get("autoClose") === "true" || urlParams.get("autoClose") === "true";
      globalParams.showDetails = formData.get("showDetails") === "true" || urlParams.get("showDetails") === "true";
      globalParams.apiBaseUrl = formData.get("apiBaseUrl") || urlParams.get("apiBaseUrl") || "https://pbirefresh.azurewebsites.net/api";
      
      // N·∫øu kh√¥ng c√≥ tham s·ªë b·∫Øt bu·ªôc, hi·ªÉn th·ªã form nh·∫≠p li·ªáu
      if (!globalParams.groupId || (!globalParams.dataflowId && !globalParams.datasetId)) {
        document.getElementById("loader").style.display = "none";
        document.getElementById("status").textContent = "Vui l√≤ng nh·∫≠p th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu l√†m m·ªõi Power BI";
        document.getElementById("timer").style.display = "none";
        document.getElementById("paramForm").classList.remove("hidden");
        document.getElementById("title").textContent = "Power BI Refresh Tool";
        
        // ƒêi·ªÅn c√°c gi√° tr·ªã ƒë√£ c√≥ v√†o form
        if (globalParams.groupId) document.getElementById("groupId").value = globalParams.groupId;
        if (globalParams.dataflowId) document.getElementById("dataflowId").value = globalParams.dataflowId;
        if (globalParams.datasetId) document.getElementById("datasetId").value = globalParams.datasetId;
        if (globalParams.requestId !== generateRequestId()) document.getElementById("requestId").value = globalParams.requestId;
        if (globalParams.apiBaseUrl !== "https://pbirefresh.azurewebsites.net/api") {
          document.getElementById("apiBaseUrl").value = globalParams.apiBaseUrl;
        }
        document.getElementById("autoClose").checked = globalParams.autoClose;
        document.getElementById("showDetails").checked = globalParams.showDetails;
        
        // X·ª≠ l√Ω s·ª± ki·ªán submit form
        document.getElementById("refreshForm").addEventListener("submit", function(e) {
          e.preventDefault();
          
          const form = e.target;
          globalParams.groupId = form.elements["groupId"].value;
          globalParams.dataflowId = form.elements["dataflowId"].value || null;
          globalParams.datasetId = form.elements["datasetId"].value || null;
          globalParams.requestId = form.elements["requestId"].value || generateRequestId();
          globalParams.apiBaseUrl = form.elements["apiBaseUrl"].value || "https://pbirefresh.azurewebsites.net/api";
          globalParams.autoClose = form.elements["autoClose"].checked;
          globalParams.showDetails = form.elements["showDetails"].checked;
          
          // Ki·ªÉm tra tham s·ªë b·∫Øt bu·ªôc
          if (!globalParams.groupId || (!globalParams.dataflowId && !globalParams.datasetId)) {
            alert("Vui l√≤ng nh·∫≠p Workspace ID v√† √≠t nh·∫•t m·ªôt trong Dataflow ID ho·∫∑c Dataset ID");
            return;
          }
          
          // ·∫®n form v√† hi·ªÉn th·ªã giao di·ªán l√†m m·ªõi
          document.getElementById("paramForm").classList.add("hidden");
          document.getElementById("loader").style.display = "block";
          document.getElementById("timer").style.display = "block";
          document.getElementById("title").textContent = "üîÑ ƒêang l√†m m·ªõi d·ªØ li·ªáu Power BI...";
          
          // Kh·ªüi t·∫°o qu√° tr√¨nh l√†m m·ªõi
          startRefresh();
        });
        
        return;
      }
      
      // N·∫øu c√≥ ƒë·ªß tham s·ªë, b·∫Øt ƒë·∫ßu qu√° tr√¨nh l√†m m·ªõi
      startRefresh();
    }
    
    // L·∫•y d·ªØ li·ªáu t·ª´ POST method (n·∫øu c√≥)
    async function getFormDataFromPost() {
      // Ki·ªÉm tra xem c√≥ ph·∫£i form POST kh√¥ng
      if (window.location.pathname.includes("refresh-dataset") && document.referrer) {
        try {
          // ƒê√¢y l√† m·ªôt c√°ch ƒë∆°n gi·∫£n nh·∫≠n bi·∫øt POST method, kh√¥ng ho√†n h·∫£o
          // Trong th·ª±c t·∫ø, b·∫°n c·∫ßn x·ª≠ l√Ω ph·ª©c t·∫°p h∆°n ho·∫∑c d√πng server-side script
          const body = document.body.textContent.trim();
          if (body && body.includes("=")) {
            const formData = new URLSearchParams(body);
            return formData;
          }
        } catch (error) {
          console.warn("Error parsing POST data:", error);
        }
      }
      return new URLSearchParams();
    }
    
    // C·∫•u h√¨nh v√† b·∫Øt ƒë·∫ßu qu√° tr√¨nh l√†m m·ªõi
    function startRefresh() {
      hasDataflow = Boolean(globalParams.dataflowId);
      hasDataset = Boolean(globalParams.datasetId);
      
      // T·∫°o URL cho c√°c API
      triggerUrl = `${globalParams.apiBaseUrl}/TriggerRefresh?groupId=${globalParams.groupId}&dataflowId=${globalParams.dataflowId || ''}&datasetId=${globalParams.datasetId || ''}&requestId=${globalParams.requestId}`;
      statusUrl = `${globalParams.apiBaseUrl}/CheckRefreshStatus?requestId=${globalParams.requestId}`;
      
      // Hi·ªÉn th·ªã/·∫©n d√≤ng trong chi ti·∫øt
      document.getElementById('row-dataflowId').style.display = hasDataflow ? 'flex' : 'none';
      document.getElementById('row-datasetId').style.display = hasDataset ? 'flex' : 'none';
      
      // ƒêi·ªÅn th√¥ng tin c∆° b·∫£n
      document.getElementById('detail-requestId').textContent = globalParams.requestId;
      document.getElementById('detail-groupId').textContent = globalParams.groupId;
      document.getElementById('detail-dataflowId').textContent = globalParams.dataflowId || 'N/A';
      document.getElementById('detail-datasetId').textContent = globalParams.datasetId || 'N/A';
      
      // Hi·ªÉn th·ªã chi ti·∫øt n·∫øu ƒë∆∞·ª£c y√™u c·∫ßu
      if (globalParams.showDetails) {
        document.getElementById('details').style.display = 'block';
      } else {
        document.getElementById('toggleDetails').classList.remove('hidden');
      }
      
      // B·∫Øt s·ª± ki·ªán khi click n√∫t hi·ªÉn th·ªã chi ti·∫øt
      document.getElementById('toggleDetails').addEventListener('click', function() {
        const detailsBox = document.getElementById('details');
        if (detailsBox.style.display === 'block') {
          detailsBox.style.display = 'none';
          this.textContent = 'Hi·ªÉn th·ªã chi ti·∫øt';
        } else {
          detailsBox.style.display = 'block';
          this.textContent = '·∫®n chi ti·∫øt';
        }
      });
      
      // Kh·ªüi ƒë·ªông b·ªô ƒë·∫øm th·ªùi gian
      startTimer();
      
      // B·∫Øt ƒë·∫ßu qu√° tr√¨nh l√†m m·ªõi
      refreshPowerBI();
    }

    // Hi·ªÉn th·ªã ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c / th·ªùi gian ch·ªù
    function startTimer() {
      let seconds = 0;
      const timerEl = document.getElementById("timer");
      const timerInterval = setInterval(() => {
        seconds++;
        timerEl.textContent = `‚è± ƒê√£ ch·ªù: ${Math.floor(seconds/60)} ph√∫t ${seconds%60} gi√¢y`;
        
        // T·ª± ƒë·ªông ƒë√≥ng c·ª≠a s·ªï n·∫øu ƒë√£ ho√†n th√†nh v√† y√™u c·∫ßu t·ª± ƒë·ªông ƒë√≥ng
        if (isRefreshCompleted && globalParams.autoClose && seconds % 60 === 0) {
          clearInterval(timerInterval);
          window.close();
        }
      }, 1000);
    }

    // T·∫°o badge cho tr·∫°ng th√°i
    function createStatusBadge(status) {
      if (!status) return '';
      
      let badgeClass = 'badge-secondary';
      if (status.includes('Completed') || status.includes('Success')) {
        badgeClass = 'badge-success';
      } else if (status.includes('Failed') || status.includes('Timeout')) {
        badgeClass = 'badge-danger';
      } else if (status.includes('Refreshing')) {
        badgeClass = 'badge-primary';
      } else if (status.includes('Waiting')) {
        badgeClass = 'badge-warning';
      }
      
      return `<span class="badge ${badgeClass}">${status}</span>`;
    }

    // G·ª≠i y√™u c·∫ßu l√†m m·ªõi
    async function refreshPowerBI() {
      document.getElementById("status").textContent = "üöÄ G·ª≠i y√™u c·∫ßu l√†m m·ªõi Power BI...";
      try {
        const res = await fetchWithTimeout(triggerUrl, { method: "GET" }, 180000);
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const result = await res.json();
        
        if (!result || result.error) {
          throw new Error(result.error || "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ server");
        }
        
        document.getElementById("status").textContent = "‚úÖ Y√™u c·∫ßu l√†m m·ªõi ƒë√£ ƒë∆∞·ª£c g·ª≠i. ƒêang theo d√µi...";
        document.getElementById('detail-status').innerHTML = 
          (hasDataflow ? `Dataflow: ${createStatusBadge(result.status || "Waiting")}<br>` : '') +
          (hasDataset ? `Dataset: ${createStatusBadge(result.status || "Waiting")}` : '');
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i
        pollStatus();
      } catch (err) {
        showError("g·ª≠i y√™u c·∫ßu l√†m m·ªõi", err);
      }
    }

    // H√†m chung ƒë·ªÉ poll tr·∫°ng th√°i v·ªõi retry logic
    async function pollStatus() {
      try {
        const res = await fetch(statusUrl);
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        if (!data || data.error) {
          throw new Error(data.error || "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ server");
        }
        
        // C·∫≠p nh·∫≠t th·ªùi gian
        if (data.lastUpdated) {
          document.getElementById('detail-lastUpdated').textContent = new Date(data.lastUpdated).toLocaleString();
        }
        
        // Hi·ªÉn th·ªã tr·∫°ng th√°i
        let statusText = "";
        let detailStatusHtml = "";
        
        // X·ª≠ l√Ω dataflow n·∫øu c√≥
        if (hasDataflow && data.dataflowId) {
          statusText += `‚è≥ Dataflow: ${data.status || "ƒêang ch·ªù"}`;
          detailStatusHtml += `Dataflow: ${createStatusBadge(data.status || "Waiting")}`;
          
          if (data.status === "DataflowCompleted" || data.status === "DataflowSuccess") {
            statusText += " ‚úÖ";
          } else if (data.status === "DataflowFailed" || data.status === "DataflowTimeout") {
            statusText += " ‚ùå";
            refreshFailed = true;
          }
        }
        
        // X·ª≠ l√Ω dataset n·∫øu c√≥
        if (hasDataset && data.datasetId) {
          if (statusText) statusText += "<br>";
          if (detailStatusHtml) detailStatusHtml += "<br>";
          
          statusText += `‚è≥ Dataset: ${data.status || "ƒêang ch·ªù"}`;
          detailStatusHtml += `Dataset: ${createStatusBadge(data.status || "Waiting")}`;
          
          if (data.status === "DatasetCompleted" || data.status === "DatasetSuccess") {
            statusText += " ‚úÖ";
          } else if (data.status === "DatasetFailed" || data.status === "DatasetTimeout") {
            statusText += " ‚ùå";
            refreshFailed = true;
          }
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i
        document.getElementById("status").innerHTML = statusText;
        document.getElementById('detail-status').innerHTML = detailStatusHtml;
        
        // Ki·ªÉm tra n·∫øu qu√° tr√¨nh ƒë√£ ho√†n th√†nh
        if (data.isCompleted) {
          isRefreshCompleted = true;
          
          if (refreshFailed) {
            document.getElementById("title").textContent = "‚ùå L√†m m·ªõi th·∫•t b·∫°i!";
            document.getElementById("status").innerHTML += "<br><br>C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh l√†m m·ªõi.";
          } else {
            document.getElementById("title").textContent = "‚úÖ L√†m m·ªõi ho√†n t·∫•t!";
            document.getElementById("status").innerHTML += "<br><br>To√†n b·ªô qu√° tr√¨nh l√†m m·ªõi ƒë√£ ho√†n t·∫•t th√†nh c√¥ng.";
            
            // T·ª± ƒë·ªông ƒë√≥ng sau 3 gi√¢y n·∫øu ƒë∆∞·ª£c y√™u c·∫ßu
            if (globalParams.autoClose) {
              setTimeout(() => window.close(), 3000);
            }
          }
          
          document.querySelector(".loader").style.display = "none";
        } else {
          // Ti·∫øp t·ª•c poll sau 30 gi√¢y n·∫øu ch∆∞a ho√†n th√†nh
          const pollInterval = hasDataflow ? 60000 : 30000; // 60s cho dataflow, 30s cho dataset
          pollTimeoutId = setTimeout(pollStatus, pollInterval);
        }
      } catch (err) {
        // Th·ª≠ l·∫°i sau 30 gi√¢y n·∫øu c√≥ l·ªói
        document.getElementById("status").innerHTML += "<br>‚ö†Ô∏è ƒêang th·ª≠ l·∫°i k·∫øt n·ªëi...";
        pollTimeoutId = setTimeout(pollStatus, 30000);
      }
    }

    // Fetch c√≥ timeout
    function fetchWithTimeout(resource, options = {}, timeout = 60000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(id));
    }

    // Hi·ªÉn th·ªã l·ªói
    function showError(context, err) {
      document.getElementById("title").textContent = "‚ùå C√≥ l·ªói x·∫£y ra";
      document.getElementById("status").textContent = `L·ªói khi ${context}: ${err.message}`;
      document.querySelector(".loader").style.display = "none";
      
      // C·∫≠p nh·∫≠t chi ti·∫øt
      document.getElementById('detail-status').innerHTML = `<span class="badge badge-danger">L·ªói</span>`;
      document.getElementById('detail-lastUpdated').textContent = new Date().toLocaleString();
      
      // Hi·ªÉn th·ªã chi ti·∫øt n·∫øu c√≥ l·ªói
      document.getElementById('details').style.display = 'block';
      document.getElementById('toggleDetails').classList.add('hidden');
    }
    
    // Kh·ªüi t·∫°o trang web
    init();
  </script>
</body>
</html>
